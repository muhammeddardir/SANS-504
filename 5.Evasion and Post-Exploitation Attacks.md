### Keeping Access

#### Backdoors and Trojan Horses
- **Backdoor :** Is program that allow an attacker to access a system, bypass security control
- Some backdoor are also trojan horses
- Trojan Normal Software contain : rootkit, NetCat listener, email attachment bots
- Malware Layers : 
	- Application Level backdoor
	- User-Mode Rootkit Techniques
	- Kernel-Mode Rootkit Techniques
***
#### Keeping Access, Application-Level Trojan Horses Suites
- Control Victim System via Network
- Examples : Poison Ivy, VNC legitimate, Dameware, DarkComet RAT, Blackshildes, Ghost RAT.
- **Virtual Network Card :** 
	- Virtual Network Computing (VNC) : TCP port 5900, Remote admin, cross platform, when configured to listen, client use TCP 5500 by default
	- VNC viewer > VNC Server
	- Win VNC Server GUI : can run in two mode (App mode "Tools", Service mode "List services")
	- **Attack :** Poison lvy Configuration : 
		1. Configuration the server
		2. Then move server exe to target
		3. use Client GUI to control the target across the network
- **Common Remote Control Backdoor Capabilities :**
	- Backdoor windows as  Poison lvy, Gh0st RAT
	- System Control Capabilities : KeyStore Logger, Get Passwords, Access files,.. etc.
	- Scareware : can used by unauthorized user to gain access in your network, Is social Engineer attack "pretending as part of large IT company as Microsoft"
***
#### Keeping Access, Wrappers and Packers
- **Wrappers :** Is a backdoor tool around some other application, Ex, wrap nc.exe into an interactive birthday card, this tool can create Trojan, Built into Poison lvy, Metasploit, Msfvenom, Veil. can warp into `.vps, .vpa` for macro with final extension `exe2vba.rb, exe2vbs.rb`
- **Use Packers :** To bypass windows Anti-Revers Engineering for executable of malicious code.
- Defense :
	- Use unpackers or use plugin for debugger
	- Immunity Debugger 
	- Ghidra
***
#### Memory Analysis, Lab 5.1 Windows Attack
- To Analysis memory dump from windows machine Tools : 
	- **Dump memory tools :** Memoryze MemoryDD.bat, fastdump, win32dd, winpmem, FTK imager and ManTech's mdd
	- **Tool for analysis :** volatility, Google's Rekall, Command pages 27-32
***
#### Rootkit Techniques
- **Rootkit :** is collection of tools that allow an attacker to : keep backdoor access in system, Mask the fact that the system is compromised, are classic example of effective Trojan
- **Tactics :** Trojan can be Replace Login, sshd, rshd, inetd, tcpd to included backdoor password, and attacker can connect in listening services port
- **Common Linux hide components :**  Process hiding, network hiding, file hiding and event hiding
	- **Process Hiding :** By Replace or redirection for `PS, top and pidof` this tools will not show the attackers process on running box, in additional attacker can replace `killall` so `killall` didn't kill any process, Finally `Crontab` program attacker add modification in `crontab` to start attacker attack when system boot or in specific time.
	- **File Hiding :** Change and Replace `ls and find` commands don't display Attacker files
	- **Event Hiding :** will not record log events associated with attacker's machine and victim account
	- **Network Hiding :** Change output of tools as `netstat and ifconfig` to hide attacker listening port and Ips
- **Windows User-Mode Rootkit Techniques : DLL injection, and API hooking**
	-   **User-mode rootkits :** operate at the application level, concealing malicious activities from user-level processes,
	- User with the debug right can inject DLL into running process.
	- Hook API : to change programs as open ports and filesystem
- **Windows Kernel-Mode Rootkit Techniques :**
	- **kernel-mode rootkits :** function at the operating system's core, hiding from both user and system-level processes, is mixed in with other user-mode techniques
	- **Tools :** sumfuq for SunOS 4.1.x,  itf.c for linux OS 
	- Kernel Interaction User Program and Hardware![[Pasted image 20231112130358.png]]
	- **Techniques :**
		- Hidden process
		- Hidden files
		- Hidden network use (sniffing and port listing)
		- Execution redirection
	- **Types of kernel mode Rootkit techniques :** each available in windows and linux 
		1. Loadable kernel modules for (UNIX) and device drivers modules for (windows) : doing overwrite in this modules functionality such as Stuxnet
		2. Altering kernel in memory : Linux `/dev/kmem` map kernel memory in linux, System memory map in windows
		3. Change kernel file hard drive : Overwrite kernel file on the hard drive : on windows by `ntoskrnl.exe` and win32k.sys files
		4. Virtualization the system : Attacker can Put legit-looking system in vm.
***
### Rootkit Examples Lab 5.2 Fun with rootkits
- **Rooty :** 
	- Is rootkit tool
	- Work on 2.6+ and 3.0+ linux kernels
	- Use driver support/loadable kernel modules
	- Component : 
		- Hides by modifying result listed by `lsmod`
		- Modify Syscall table : Hide Process, Files and Directory, Port usage
		- Real time hiding from strace
	- The Attacker can implement a cone of silence (inside cone : all hidden item are visible, Outside cone : all hidden item are Hidden)
- **Avatar :**
	- It use to different driver infection techniques when it is enable,
		- Once to bypass HIDS
		- Second for persistence
	- Use bootkit method of infection and persistence, to bypass driver signing requirement.
	- Is mixture User-Mode and Kernel-Mode techniques
	- Attempts to detect whether the target system is a VM
	- Custom encryption used for C&C
	- Hide : Process, Connection, Logged in user and Give UID zero Privilege to any process, Use File system Function hook, Redirect read function to evil indoes for example : netstat reads data from /proc/net/tcp
- Defense Rootkit : config. Lockdown
	- Use a good security templet
	- Center for Internet Security (CIS) in conjunction with NSA, NIST, and other hardening template : work in most OS as Machine or Routers or IOT
	- **Detection Tools :** Chkrootkit "free check for 50 rootkit user and Kernel mode", Rootkit hunter, OSSEC
	- **Windows Rootkit Detector :** Sophos Anti-Rootkit, McAfee Rootkit Remover, GMER
	- **File Integrity Checking tools :** Tripwire, OSSEC Recommended
	- **Network Intelligence forensics :** RITA, Nifty
	- Kernel-Mode Rootkit Defense : Contain, Erad and Recovery
		- Contain : Analyze other systems changes made by discovered rootkit
		- Eradication : Wipe Drive, Reinstall OS, Patch OS, Change all admin Passwords
		- Recovery : Monitor System very Carefully
***
#### Covering Tracks

##### Covering Tracks in linux, Lab 5.3 shell history analysis
- **Hiding Files :** 
	- Make file name as : `. or ..` there is a space after this dots.
	- Attacker Put hidden file in UNIX : `/dev, /tmp, /etc`, `/usr/local/man`, `/usr/src`
- **Log Edit :**
	- Log file path : `/etc/syslog.conf`, `/var/log/source`, `/var/log/message`, `/var/log/httpd`
	- Shell history : Solution of shell history : `kill -9 bash`, `unset HISTFILE; kill -9 $$`
- **Account Entry Edit :**
	- Attacker can't edit this file by hand can edit by specific tool to understand this format : utmp, wtmp, btmp and lastlog : and this file used to logs login process we can find it under `/var/log`
##### Covering Tracks in Windows, Lab, 5.4 Alternate Data Stream, Lab 5.5 windows log Editing
- Hide Files in NTFS : 
	- Attacker can hide file in stream behind normal files on the system use `type hack.exe > notebad.exe:stream1.exe` or `cp hack.exe notebad.exe:stream1.exe` to get back data `cp notebad.exe:stream1.exe hack.exe` you can create alternative data stream attached to directory by `notebad <file_or_dir_name>:<stream_name>`  you can view stream content by `more < C:\notebad.exe:stream1.exe`
	- Alternate Data Stream in NTFS **ADS** :
		- On Windows NTFS file systems, an Alternate Data Stream is a feature that allows more than one data stream to be associated with a filename.
		- Identify and list ADS data with `dir /r` or `Get-Item * -stream*`, will not show ADS behind windows reversed filename as : COM1, COM2, LPT1, AUX, etc.
		- **Finding Hidden Stream :** Use Anti-Antivirus ADS Detection  
- **Log Editing :**
	- An attacker with admin privileges can clear event logs can do it by tool `DenderSpritz`, or `metesploit command clearv` : Clear all events logs
- **Defense :**
	- **Preparation :** Use Separated server for logs as windows log server (WEF), Cryptographic integrity check of log files 
	- **Identification :** Look for gaps and corrupt logs
	- **JPCert :** Project of attacks and artifacts generated in logs, files and registry
	- **UBEA**  : User behavior entity Analytics 
	- **Check baseline**
	- **Login Tracer**
##### Covering Tracks on Network, Lab 5.6 Covert Channel
- **Revers HTTP Shell**
- **ICMP Tunneling :**
	- Ptunnel Tool : Carry data inside ICMP Payload, (TCP over ICMP Echo and Reply) Client-Agent.
- **Covert TCP :**
	- Instead of tunneling data across other protocols as  HTTP, ICMP, we can create a covert channel using extra space in TCP or IP header
	- Covert_TCP Tool : to create a covert channel using extra space in TCP or IP header, Client and server
- **Other Covert Channel :** 
	- For any protocol as DNS, by tool  DNSCat2
	- Quick UDP Internet Connection : (QUIC)
	- Stream Windows Transmission Protocol (SCTP), Build-in C2 server 
- **Gcat :** 
	- Full C&C backdoor over Gmail, Screenshot, download and Upload files, keylogger, execute shellcode
	- Can Bypass Many DLP/IDS/IPS systems, because this solution don't monitor Gmail traffic very well. 
- **Covert_Channel Defense :**
	- Preparation : keep attacker off system in first place
	- Identification : Check Starting process, NIDS analyze Packet.
	- Containment : Delete attacker programmer
	- Eradication : if attacker compromised admin/root rebuild system
	- Recovery : Monitor system very closely 
- **Steganography :**
	- Can Hide data in : Image, Word, Text, Machine Image
	- **Tools :** 
		- Jsteg : Hide in Jpeg images using the DCT coefficient
		- MP3Stego : Hide in Mpeg files
		- S-Mail : Hide data in EXE and DLL files
		- Invisible Secret : Hide data in banner ads that appear in website
		- Stash : Hide data in variety of image formats
		- Hydan : Hide data in UNIX/Linux and windows executable [page 113-116]
		- Open Stego : Embed data and digital watermark into image
		- SilentEye : Embed encrypted data and other files into JPEG, BMP and WAV files
		- OpenPuff : Support for Images, audio, video and adobe flash files
- Detecting Stego : 
	- Stego Expose : Java tool to detect Stego
	- Preparation : Get Familiar with Stego tools 
	- Identification : If you have the original Source image detect it easy by MD5 check
	- Containment : Work with your law enforcement and HR
	- Erad, Recov : Work with your Company's legal team
***
##### Credit Card Theft 
- Page [121-132]
##### TGTarget Scenario
- Page [134-151]

